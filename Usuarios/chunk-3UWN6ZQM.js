import{e as L}from"./chunk-SQFV6KDN.js";import{F,H as A,L as J}from"./chunk-XAHG6FXJ.js";import{Da as B,Ia as P,q as b,z as M}from"./chunk-YEU4SLVL.js";import{$a as j,Db as l,E as C,Eb as u,Fb as R,I as D,Pb as _,X as x,Zb as p,_ as m,_a as k,_b as O,ca as g,cc as U,g as S,h as E,ia as c,l as a,la as I,m as y,q as d,sb as w,z as f}from"./chunk-NQMNK77Y.js";import{a as v}from"./chunk-NEB6MB4Y.js";var H=(()=>{let t=class t{constructor(){this._httpClient=c(b),this._user=new E(1)}set user(e){this._user.next(e)}get user$(){return this._user.asObservable()}get(){return this._httpClient.get("api/common/user").pipe(m(e=>{this._user.next(e)}))}update(e){return this._httpClient.patch("api/common/user",{user:e}).pipe(d(i=>{this._user.next(i)}))}};t.\u0275fac=function(i){return new(i||t)},t.\u0275prov=g({token:t,factory:t.\u0275fac,providedIn:"root"});let s=t;return s})();var h=class{static isTokenExpired(t,r){if(!t||t==="")return!0;let e=this._getTokenExpirationDate(t);return r=r||0,e===null?!0:!(e.valueOf()>new Date().valueOf()+r*1e3)}static _b64decode(t){let r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",e="";if(t=String(t).replace(/=+$/,""),t.length%4===1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(let i=0,n,o,T=0;o=t.charAt(T++);~o&&(n=i%4?n*64+o:o,i++%4)?e+=String.fromCharCode(255&n>>(-2*i&6)):0)o=r.indexOf(o);return e}static _b64DecodeUnicode(t){return decodeURIComponent(Array.prototype.map.call(this._b64decode(t),r=>"%"+("00"+r.charCodeAt(0).toString(16)).slice(-2)).join(""))}static _urlBase64Decode(t){let r=t.replace(/-/g,"+").replace(/_/g,"/");switch(r.length%4){case 0:break;case 2:{r+="==";break}case 3:{r+="=";break}default:throw Error("Illegal base64url string!")}return this._b64DecodeUnicode(r)}static _decodeToken(t){if(!t)return null;let r=t.split(".");if(r.length!==3)throw new Error("The inspected token doesn't appear to be a JWT. Check to make sure it has three parts and see https://jwt.io for more.");let e=this._urlBase64Decode(r[1]);if(!e)throw new Error("Cannot decode the token.");return JSON.parse(e)}static _getTokenExpirationDate(t){let r=this._decodeToken(t);if(r.iat=new Date(r.iat),r.iat=Math.floor(r.iat.getTime()/1e4),!r.hasOwnProperty("exp"))return null;let e=new Date(0);return e.setUTCSeconds(r.exp),e.setUTCSeconds(r.exp),e}static getTokenExpirationTime(t){if(!t)return null;try{let r=JSON.parse(atob(t.split(".")[1]));return r.exp?new Date(r.exp*1e3):null}catch(r){return console.error("Error decoding token:",r),null}}};var q=(()=>{let t=class t{constructor(e){this.dialogRef=e,this.countDown=30,f(1e3).pipe(D(30)).subscribe(i=>{this.countDown=29-i,this.countDown===0&&this.dialogRef.close(!1)})}onRenew(){this.dialogRef.close(!0)}onLogout(){this.dialogRef.close(!1)}};t.\u0275fac=function(i){return new(i||t)(j(F))},t.\u0275cmp=I({type:t,selectors:[["app-tokenrenewaldialog"]],standalone:!0,features:[U],decls:17,vars:3,consts:[[1,"relative","flex","h-full","w-full","flex-col"],[1,"flex","flex-auto","flex-col","items-center","pb-6","sm:flex-row","sm:items-start","sm:pb-8"],[1,"flex","h-10","w-10","flex-0","items-center","justify-center","rounded-full","sm:mr-4","bg-blue-100","text-blue-600","dark:bg-blue-600","dark:text-blue-50"],[3,"svgIcon"],[1,"flex","flex-col","items-center","space-y-1","text-center","sm:mt-0","sm:items-start","sm:pr-8","sm:text-left"],[1,"text-xl","font-medium","leading-6"],[1,"text-secondary"],[1,"flex","items-center","justify-center","space-x-3","bg-gray-50","py-4","dark:bg-black","dark:bg-opacity-10","sm:justify-end"],["mat-flat-button","",1,"sm:w-auto","w-full","bg-crediblue-50","hover:bg-crediblue-100","text-white","font-semibold","py-2","px-4","rounded-lg","transition","duration-200",3,"click","color"],["mat-stroked-button","",1,"sm:w-auto","w-full","bg-crediorange-100","rounded-lg","transition","duration-200","text-white","font-semibold",3,"click"]],template:function(i,n){i&1&&(l(0,"div",0)(1,"div",1)(2,"div",2),R(3,"mat-icon",3),u(),l(4,"div",4)(5,"h2",5),p(6,"Tu sesi\xF3n est\xE1 por expirar"),u(),l(7,"p",6),p(8,"Tu sesi\xF3n expirar\xE1 en "),l(9,"strong"),p(10),u(),p(11," segundos."),u()()(),l(12,"div",7)(13,"button",8),_("click",function(){return n.onRenew()}),p(14," Extender "),u(),l(15,"button",9),_("click",function(){return n.onLogout()}),p(16," Cerrar sesi\xF3n "),u()()()),i&2&&(k(3),w("svgIcon","heroicons_solid:question-mark-circle"),k(7),O(n.countDown),k(3),w("color","primary"))},dependencies:[B,P]});let s=t;return s})();var he=(()=>{let t=class t{constructor(){this._authenticated=!1,this._httpClient=c(b),this._userService=c(H),this._appSettings=c(J),this.aesEncriptService=c(L),this.matDialog=c(A),this.router=c(M),this._tokenExpirationSubject=new S(!1),this.restoreSession(),this.checkTokenExpiration()}restoreSession(){if(!this.accessToken||!this.accessRefreshToken){this.signOut();return}h.isTokenExpired(this.accessToken)?(console.log("Token expirado, intentando renovar..."),this.signInUsingToken().subscribe(e=>{e?(console.log("Token renovado exitosamente."),this._authenticated=!0):(console.log("No se pudo renovar el token, cerrando sesi\xF3n..."),this.signOut())})):(console.log("Token v\xE1lido, restaurando sesi\xF3n..."),this._authenticated=!0)}set accessToken(e){localStorage.setItem("accessToken",e)}set refreshToken(e){localStorage.setItem("refreshToken",e)}get accessToken(){return localStorage.getItem("accessToken")??""}get accessRefreshToken(){return localStorage.getItem("refreshToken")??""}forgotPassword(e){return this._httpClient.post("api/auth/forgot-password",e)}resetPassword(e){return this._httpClient.post("api/auth/reset-password",e)}signIn(e){let i={correo:e.correo,contrasena:e.contrasena,idTipoUsuario:e.idTipoUsuario},n={login:this.aesEncriptService.encryptObject(i)};return this._authenticated?y("User is already logged in."):this._httpClient.post(this._appSettings.auth.url.base,n).pipe(d(o=>{let T={id:Math.random().toString(),name:o.data.nombre,email:o.data.correo,avatar:"images/avatars/avatar-user.png",status:"online"};return o.tokenType="bearer",o.user=v({},T),delete o.data,o}),x(o=>(this.accessToken=o.accessToken,this.refreshToken=o.refreshToken,this._authenticated=!0,this._userService.user=o.user,a(o))))}signInUsingToken(){let e=this.accessToken,i=this.accessRefreshToken;return!e||!i?(this.signOut(),a(!1)):(console.log("Verificando token con API..."),this._httpClient.post(this._appSettings.auth.url.baseRefresh,{token:e,refreshToken:i}).pipe(C(n=>(this.signOut(),a(!1))),x(n=>n.token?(this.accessToken=n.token,this.refreshToken=n.refreshToken,this._authenticated=!0,a(!0)):(this.signOut(),a(!1)))))}checkTokenExpiration(){f(1e4).pipe(m(()=>{let e=this.accessToken;if(e){let n=h.getTokenExpirationTime(e)-Date.now();n>0&&n<=6e4&&(this._tokenExpirationSubject.value||(this._tokenExpirationSubject.next(!0),this.openTokenRenewalDialog())),n<=0&&(this._tokenExpirationSubject.value||(this._tokenExpirationSubject.next(!0),this.openTokenRenewalDialog()))}})).subscribe()}openTokenRenewalDialog(){this.matDialog.open(q,{width:"400px",disableClose:!0}).afterClosed().subscribe(i=>{i?this.signInUsingToken().subscribe():(this.signOut(),this.router.navigate(["/sign-in"]))})}logoutSession(){return this._httpClient.post(this._appSettings.auth.url.baseOut,{})}signOut(){return localStorage.removeItem("accessToken"),localStorage.removeItem("accessToken"),localStorage.removeItem("refreshToken"),this._authenticated=!1,this._userService.user=null,this.router.navigate(["/sign-in"]),a(!0)}signUp(e){return this._httpClient.post(this._appSettings.authTrabajador.url.base,e)}unlockSession(e){return this._httpClient.post("api/auth/unlock-session",e)}check(){return this._authenticated?a(!0):this.accessToken?h.isTokenExpired(this.accessToken)?a(!1):a(!0):a(!1)}};t.\u0275fac=function(i){return new(i||t)},t.\u0275prov=g({token:t,factory:t.\u0275fac,providedIn:"root"});let s=t;return s})();export{h as a,H as b,he as c};
